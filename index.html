<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>Ê•µÁ∞°Â§©Ê∞£ ‚Äî Slider Áâà</title>
    <link rel="icon" type="image/png" href="./icon-v2.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --card-bg: rgba(255, 255, 255, 0.75);
            --glass-bg: rgba(255, 255, 255, 0.25);
            --accent: #007AFF;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: linear-gradient(180deg, #FFF9E3 0%, #FFE8B8 100%);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background 0.5s ease;
            padding-bottom: 40px;
        }

        body.dawn { background: linear-gradient(180deg, #E8E8E8 0%, #F5F5F7 100%); }
        body.day { background: linear-gradient(180deg, #FFF9E3 0%, #FFE8B8 100%); }
        body.evening { background: linear-gradient(180deg, #B8D8D8 0%, #8FB8C8 100%); }
        body.night { background: linear-gradient(180deg, #2C3E50 0%, #1A252F 100%); color: #fff; }

        .loading-screen {
            position: fixed; inset: 0;
            display:flex; align-items:center; justify-content:center; flex-direction:column;
            background: linear-gradient(180deg, #FFF9E3 0%, #FFE8B8 100%);
            z-index: 999;
        }
        .spinner { width:48px;height:48px;border:3px solid rgba(0,0,0,0.08);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;}
        @keyframes spin { to{ transform: rotate(360deg); } }

        .navbar {
            position: sticky; top: 0; z-index: 50;
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 0.5px solid rgba(0,0,0,0.05);
        }
        .nav-content { max-width:700px; margin:0 auto; padding:12px 20px; display:flex; justify-content:space-between; align-items:center; gap:12px; }

        .location-selector { display:flex; align-items:center; gap:12px; }
        .city-dropdown {
            padding:8px 12px; font-size:16px; font-weight:600; border-radius:10px;
            border:1px solid rgba(0,0,0,0.12); background: rgba(255,255,255,0.8); cursor:pointer;
        }
        body.night .city-dropdown { background: rgba(255,255,255,0.08); color:#fff; border-color: rgba(255,255,255,0.12); }

        .update-time { font-size:13px; color:var(--text-secondary); font-weight:500; white-space:nowrap; }

        .container { max-width:700px; margin: 18px auto; padding: 0 20px 40px; }

        /* Slider area */
        .slider-wrap {
            overflow: hidden;
            border-radius: 18px;
            position: relative;
        }
        .slider-track {
            display:flex;
            transition: transform 300ms cubic-bezier(.22,.9,.2,1);
            touch-action: pan-y;
        }
        .slide {
            min-width:100%;
            padding:28px 22px;
            display:flex;
            gap:20px;
            align-items:center;
            justify-content:center;
        }

        .hero-card {
            width:100%;
            max-width:560px;
            background: var(--card-bg);
            border-radius:18px;
            padding:22px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            border: 0.5px solid rgba(255,255,255,0.6);
        }

        .period-badge { display:inline-block; padding:6px 12px; background: rgba(0,122,255,0.12); color:var(--accent); border-radius:10px; font-weight:600; margin-bottom:10px; font-size:13px;}

        .temp-display { display:flex; align-items:center; justify-content:flex-start; gap:18px; margin:10px 0 4px; }
        .weather-icon { font-size:72px; filter: drop-shadow(0 2px 8px rgba(0,0,0,0.08)); }
        .temp-main { font-size:56px; font-weight:300; letter-spacing:-2px; }
        .weather-desc { font-size:17px; font-weight:600; color:var(--text-secondary); margin-top:4px; }

        .advice-grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:18px; }
        .advice-item { background: rgba(0,0,0,0.04); border-radius:12px; padding:12px; text-align:center; }
        .advice-icon { font-size:28px; margin-bottom:6px; }
        .advice-title { font-weight:700; font-size:14px; }
        .advice-detail { font-size:12px; color:var(--text-secondary); }

        /* slider dots */
        .dots { display:flex; gap:8px; justify-content:center; margin-top:12px; }
        .dot { width:8px; height:8px; border-radius:50%; background:rgba(0,0,0,0.12); cursor:pointer; transition: all 160ms; }
        .dot.active { width:28px; height:8px; border-radius:999px; background:var(--accent); }

        /* forecast small cards container below */
        .forecast-scroll { display:flex; gap:12px; overflow-x:auto; padding-top:18px; padding-bottom:8px; }
        .forecast-card { min-width:120px; background: var(--card-bg); border-radius:12px; padding:12px; text-align:center; border:0.5px solid rgba(255,255,255,0.5); }

        /* Night mode tweaks */
        body.night .hero-card,
        body.night .forecast-card {
            background: rgba(255,255,255,0.06);
            border-color: rgba(255,255,255,0.08);
        }
        body.night .weather-desc, body.night .update-time { color: rgba(255,255,255,0.7); }

        /* small responsive */
        @media (max-width:420px) {
            .temp-main { font-size:44px; }
            .weather-icon { font-size:56px; }
        }
    </style>
</head>

<body>
    <div id="loading" class="loading-screen">
        <div class="spinner"></div>
        <p style="margin-top:12px; color:var(--text-secondary); font-weight:500;">ËºâÂÖ•Â§©Ê∞£Ë≥áÊñô...</p>
    </div>

    <nav class="navbar">
        <div class="nav-content">
            <div class="location-selector">
                <select id="citySelect" class="city-dropdown" aria-label="ÈÅ∏ÊìáÂüéÂ∏Ç"></select>
            </div>
            <div class="update-time" id="updateTime">Êõ¥Êñ∞‰∏≠...</div>
        </div>
    </nav>

    <div class="container" id="mainContent" style="display:none;">
        <!-- Slider -->
        <div class="slider-wrap" id="sliderWrap" aria-roledescription="carousel">
            <div class="slider-track" id="sliderTrack">
                <!-- Three slides (ÁèæÂú® / ÊòéÂ§© / ÂæåÂ§©) Áî± renderWeather Â°´ÂÖ• -->
                <div class="slide" data-index="0"><div class="hero-card" id="slide-0">ËºâÂÖ•‰∏≠...</div></div>
                <div class="slide" data-index="1"><div class="hero-card" id="slide-1">ËºâÂÖ•‰∏≠...</div></div>
                <div class="slide" data-index="2"><div class="hero-card" id="slide-2">ËºâÂÖ•‰∏≠...</div></div>
            </div>
        </div>
        <div class="dots" id="dotsContainer" aria-hidden="false">
            <div class="dot active" data-dot="0"></div>
            <div class="dot" data-dot="1"></div>
            <div class="dot" data-dot="2"></div>
        </div>

        <h2 style="margin-top:20px; font-size:20px; font-weight:700;">È†êÂ†±</h2>
        <div class="forecast-scroll" id="futureForecasts"></div>
    </div>

    <script>
        console.log('=== Weather Slider App Start ===');

        const CITIES = [
            'Ëá∫ÂåóÂ∏Ç','Êñ∞ÂåóÂ∏Ç','Ê°ÉÂúíÂ∏Ç','Ëá∫‰∏≠Â∏Ç','Ëá∫ÂçóÂ∏Ç','È´òÈõÑÂ∏Ç',
            'Âü∫ÈöÜÂ∏Ç','Êñ∞Á´πÂ∏Ç','Êñ∞Á´πÁ∏£','ËãóÊ†óÁ∏£','ÂΩ∞ÂåñÁ∏£','ÂçóÊäïÁ∏£',
            'Èõ≤ÊûóÁ∏£','ÂòâÁæ©Â∏Ç','ÂòâÁæ©Á∏£','Â±èÊù±Á∏£','ÂÆúËò≠Á∏£','Ëä±ËìÆÁ∏£',
            'Ëá∫Êù±Á∏£','ÊæéÊπñÁ∏£','ÈáëÈñÄÁ∏£','ÈÄ£Ê±üÁ∏£'
        ];

        const CITY_API_MAP = {
            'Ëá∫ÂåóÂ∏Ç': 'taipei','Êñ∞ÂåóÂ∏Ç': 'newtaipei','Ê°ÉÂúíÂ∏Ç': 'taoyuan','Ëá∫‰∏≠Â∏Ç': 'taichung','Ëá∫ÂçóÂ∏Ç': 'tainan','È´òÈõÑÂ∏Ç': 'kaohsiung',
            'Âü∫ÈöÜÂ∏Ç': 'keelung','Êñ∞Á´πÂ∏Ç': 'hsinchu-city','Êñ∞Á´πÁ∏£': 'hsinchu','ËãóÊ†óÁ∏£': 'miaoli','ÂΩ∞ÂåñÁ∏£': 'changhua','ÂçóÊäïÁ∏£': 'nantou',
            'Èõ≤ÊûóÁ∏£': 'yunlin','ÂòâÁæ©Â∏Ç': 'chiayi-city','ÂòâÁæ©Á∏£': 'chiayi','Â±èÊù±Á∏£': 'pingtung','ÂÆúËò≠Á∏£': 'yilan','Ëä±ËìÆÁ∏£': 'hualien',
            'Ëá∫Êù±Á∏£': 'taitung','ÊæéÊπñÁ∏£': 'penghu','ÈáëÈñÄÁ∏£': 'kinmen','ÈÄ£Ê±üÁ∏£': 'lienchiang'
        };

        let currentCityIndex = 1; // Êñ∞ÂåóÂ∏Ç
        const API_BASE = "https://weather-newtaipei-lk.zeabur.app/api/weather";

        // Slider state
        const sliderTrack = document.getElementById('sliderTrack');
        const sliderWrap = document.getElementById('sliderWrap');
        const dotsContainer = document.getElementById('dotsContainer');
        let activeIndex = 0;
        let isDragging = false;
        let startX = 0;
        let currentTranslate = 0;
        let prevTranslate = 0;
        let animationID = 0;

        function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }

        function setSliderPosition(index, animate = true) {
            activeIndex = clamp(index, 0, 2);
            const width = sliderWrap.clientWidth;
            if (!animate) sliderTrack.style.transition = 'none';
            else sliderTrack.style.transition = 'transform 300ms cubic-bezier(.22,.9,.2,1)';
            sliderTrack.style.transform = `translateX(${ -activeIndex * width }px)`;
            // dots
            document.querySelectorAll('.dot').forEach(d => d.classList.remove('active'));
            const dot = document.querySelector(`.dot[data-dot="${activeIndex}"]`);
            if (dot) dot.classList.add('active');
            // store prevTranslate
            prevTranslate = -activeIndex * width;
            currentTranslate = prevTranslate;
        }

        function pointerDown(e) {
            isDragging = true;
            startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
            sliderTrack.style.transition = 'none';
            animationID = requestAnimationFrame(animation);
        }
        function pointerMove(e) {
            if (!isDragging) return;
            const currentX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
            const dx = currentX - startX;
            currentTranslate = prevTranslate + dx;
        }
        function pointerUp() {
            if (!isDragging) return;
            cancelAnimationFrame(animationID);
            isDragging = false;
            const width = sliderWrap.clientWidth;
            const moved = currentTranslate - prevTranslate;
            // determine to snap
            const threshold = width * 0.2;
            if (moved > threshold) { // moved right => previous
                setSliderPosition(activeIndex - 1);
            } else if (moved < -threshold) { // moved left => next
                setSliderPosition(activeIndex + 1);
            } else {
                setSliderPosition(activeIndex);
            }
        }
        function animation() {
            sliderTrack.style.transform = `translateX(${currentTranslate}px)`;
            if (isDragging) animationID = requestAnimationFrame(animation);
        }

        // make slider responsive on resize
        window.addEventListener('resize', () => setSliderPosition(activeIndex, false));

        // dot click
        dotsContainer.addEventListener('click', (e) => {
            const d = e.target.closest('.dot');
            if (!d) return;
            const idx = parseInt(d.dataset.dot, 10);
            setSliderPosition(idx);
        });

        // attach pointer events
        sliderWrap.addEventListener('touchstart', pointerDown, {passive:true});
        sliderWrap.addEventListener('touchmove', pointerMove, {passive:true});
        sliderWrap.addEventListener('touchend', pointerUp, {passive:true});
        sliderWrap.addEventListener('mousedown', (e) => { e.preventDefault(); pointerDown(e); });
        window.addEventListener('mousemove', pointerMove);
        window.addEventListener('mouseup', pointerUp);

        // Utility functions
        function getWeatherIcon(weather) {
            if (!weather) return "üå§Ô∏è";
            if (weather.includes("Êô¥")) return "‚òÄÔ∏è";
            if (weather.includes("Â§öÈõ≤")) return "‚õÖ";
            if (weather.includes("Èô∞")) return "‚òÅÔ∏è";
            if (weather.includes("Èõ®")) return "üåßÔ∏è";
            if (weather.includes("Èõ∑")) return "‚õàÔ∏è";
            return "üå§Ô∏è";
        }
        function parseTemp(tempStr) {
            if (!tempStr) return 0;
            const num = parseInt(tempStr.toString().replace(/[^0-9-]/g, ''));
            return isNaN(num) ? 0 : num;
        }
        function getTimePeriod(startTime) {
            const hour = new Date(startTime).getHours();
            if (hour >= 5 && hour < 11) return "Ê∏ÖÊô®";
            if (hour >= 11 && hour < 14) return "‰∏≠Âçà";
            if (hour >= 14 && hour < 18) return "‰∏ãÂçà";
            if (hour >= 18 && hour < 23) return "Êôö‰∏ä";
            return "Ê∑±Â§ú";
        }
        function formatDateLabel(offsetDays) {
            if (offsetDays === 0) return "ÁèæÂú®";
            if (offsetDays === 1) return "ÊòéÂ§©";
            if (offsetDays === 2) return "ÂæåÂ§©";
            return "";
        }
        function getAdvice(rainProb, maxTemp) {
            const rain = parseInt(rainProb) || 0;
            const temp = parseTemp(maxTemp);
            return {
                rain: rain > 30 ? { icon: "‚òÇÔ∏è", text: "Êúâ‰∫∫ÊúÉÊ∑ãÈõ®", detail: `ÈôçÈõ®Áéá ${rainProb}` }
                                 : { icon: "üåÇ", text: "ÂøòË®ò‰Ω†ÁöÑÂÇò", detail: `ÈôçÈõ®Áéá ${rainProb}` },
                cloth: temp >= 28 ? { icon: "üëï", text: "Á©ø‰∏äÁü≠Ë¢ñ", detail: `ÊúÄÈ´ò ${maxTemp}` } :
                       temp <= 20 ? { icon: "üß•", text: "Â∏∂‰∏äÂ§ñÂ•ó", detail: `ÊúÄÈ´ò ${maxTemp}` } :
                       { icon: "üëî", text: "ËàíÈÅ©Á©øÊê≠", detail: `ÊúÄÈ´ò ${maxTemp}` }
            };
        }

        // Find the first forecast object that belongs to (today + offsetDays)
        function findForecastByDay(forecasts, offsetDays) {
            const target = new Date();
            target.setHours(0,0,0,0);
            target.setDate(target.getDate() + offsetDays);
            for (const f of forecasts) {
                const d = new Date(f.startTime);
                const dd = new Date(d.getFullYear(), d.getMonth(), d.getDate());
                if (dd.getTime() === target.getTime()) return f;
            }
            // fallback: return best-effort: pick the forecast at index offsetDays if exists
            if (forecasts[offsetDays]) return forecasts[offsetDays];
            return forecasts[0] || null;
        }

        function renderSlideCard(containerId, label, forecast) {
            const el = document.getElementById(containerId);
            if (!forecast) {
                el.innerHTML = `<div style="padding:28px;text-align:center;font-weight:600;color:var(--text-secondary)">ÁÑ°Ë≥áÊñô</div>`;
                return;
            }
            const avgTemp = Math.round((parseTemp(forecast.maxTemp) + parseTemp(forecast.minTemp))/2);
            const advice = getAdvice(forecast.rain, forecast.maxTemp);
            const period = label === "ÁèæÂú®" ? getTimePeriod(forecast.startTime) : label;
            el.innerHTML = `
                <div class="period-badge">${period}</div>
                <div style="display:flex;align-items:center;gap:16px;">
                    <div style="flex:0 0 auto;">
                        <div class="weather-icon">${getWeatherIcon(forecast.weather)}</div>
                    </div>
                    <div style="flex:1 1 auto;">
                        <div class="temp-main">${avgTemp}¬∞</div>
                        <div class="weather-desc">${forecast.weather}</div>
                        <div style="margin-top:12px;">
                            <div style="font-size:13px;color:var(--text-secondary);">Ê∫´Â∫¶Ôºö${forecast.minTemp} / ${forecast.maxTemp}</div>
                            <div style="font-size:13px;color:var(--text-secondary);">ÈôçÈõ®Ê©üÁéáÔºö${forecast.rain}</div>
                        </div>
                    </div>
                </div>
                <div class="advice-grid" style="margin-top:16px;">
                    <div class="advice-item">
                        <div class="advice-icon">${advice.rain.icon}</div>
                        <div class="advice-title">${advice.rain.text}</div>
                        <div class="advice-detail">${advice.rain.detail}</div>
                    </div>
                    <div class="advice-item">
                        <div class="advice-icon">${advice.cloth.icon}</div>
                        <div class="advice-title">${advice.cloth.text}</div>
                        <div class="advice-detail">${advice.cloth.detail}</div>
                    </div>
                </div>
            `;
        }

        function renderForecastList(forecasts) {
            const container = document.getElementById('futureForecasts');
            container.innerHTML = '';
            const todayDate = new Date().getDate();
            forecasts.forEach(f => {
                const fDate = new Date(f.startTime);
                const label = (fDate.getDate() === todayDate) ? getTimePeriod(f.startTime) :
                              (fDate.getDate() === (new Date().getDate()+1)) ? 'ÊòéÂ§©' :
                              (fDate.getDate() === (new Date().getDate()+2)) ? 'ÂæåÂ§©' : `${fDate.getMonth()+1}/${fDate.getDate()}`;
                const card = document.createElement('div');
                card.className = 'forecast-card';
                card.innerHTML = `
                    <div style="font-weight:700;color:var(--text-secondary);font-size:13px;">${label}</div>
                    <div style="font-size:28px;margin:8px 0;">${getWeatherIcon(f.weather)}</div>
                    <div style="font-weight:700">${f.minTemp} - ${f.maxTemp}</div>
                    <div style="font-size:12px;color:var(--text-secondary);margin-top:6px;">üíß ${f.rain}</div>
                `;
                container.appendChild(card);
            });
        }

        function updateBackgroundByTime() {
            const hour = new Date().getHours();
            document.body.classList.remove('dawn','day','evening','night');
            if (hour >=5 && hour < 11) document.body.classList.add('dawn');
            else if (hour >= 11 && hour < 18) document.body.classList.add('day');
            else if (hour >= 18 && hour < 23) document.body.classList.add('evening');
            else document.body.classList.add('night');
        }

        async function fetchWeather() {
            console.log('fetchWeather start');
            const cityName = CITIES[currentCityIndex];
            const cityCode = CITY_API_MAP[cityName];
            const API_URL = `${API_BASE}/${cityCode}`;

            // show loading
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';

            try {
                const resp = await fetch(API_URL);
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                const json = await resp.json();
                if (!json.success || !json.data) throw new Error('API data error');

                const data = json.data;
                const forecasts = data.forecasts || [];

                // fill slides: now, tomorrow, day after
                const f0 = findForecastByDay(forecasts, 0);
                const f1 = findForecastByDay(forecasts, 1);
                const f2 = findForecastByDay(forecasts, 2);

                renderSlideCard('slide-0', formatDateLabel(0), f0);
                renderSlideCard('slide-1', formatDateLabel(1), f1);
                renderSlideCard('slide-2', formatDateLabel(2), f2);

                // update forecast list
                renderForecastList(forecasts);

                // update updateTime
                const now = new Date();
                const weekDays = ['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'];
                document.getElementById('updateTime').textContent = `${now.getMonth()+1}/${now.getDate()} ÈÄ±${weekDays[now.getDay()]}`;

                // set slider to first slide
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    // ensure slider layout measured
                    setSliderPosition(0, false);
                }, 260);

                // log
                console.log('fetchWeather success', { cityName, API_URL, forecastsCount: forecasts.length });

            } catch (err) {
                console.error('fetchWeather error', err);
                document.getElementById('loading').innerHTML = `
                    <div class="error-box" style="text-align:center;padding:20px;">
                        <div style="font-size:48px;">‚ö†Ô∏è</div>
                        <p style="margin-top:12px;color:var(--text-secondary);font-weight:600;">ÁÑ°Ê≥ïËºâÂÖ•Â§©Ê∞£Ë≥áÊñô</p>
                        <p style="margin-top:6px;color:var(--text-secondary);font-size:13px;">${err.message}</p>
                        <button class="retry-btn" onclick="location.reload()" style="margin-top:12px;padding:10px 18px;border-radius:10px;border:none;background:var(--accent);color:#fff;font-weight:600;">ÈáçÊñ∞ËºâÂÖ•</button>
                    </div>
                `;
            }
        }

        /* ------------------------------
           ÂàùÂßãÂåñ‰∏ãÊãâÈÅ∏ÂñÆ & ‰∫ã‰ª∂Á∂ÅÂÆö
           ------------------------------ */
        document.addEventListener('DOMContentLoaded', () => {
            updateBackgroundByTime();

            const citySelect = document.getElementById('citySelect');
            CITIES.forEach((c, idx) => {
                const opt = document.createElement('option');
                opt.value = idx;
                opt.textContent = c;
                citySelect.appendChild(opt);
            });
            citySelect.value = currentCityIndex;

            citySelect.addEventListener('change', (e) => {
                currentCityIndex = parseInt(e.target.value, 10);
                // reset to first slide on city change
                setSliderPosition(0);
                fetchWeather();
            });

            // initial load
            fetchWeather();
        });

    </script>
</body>

</html>
