<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ê•µÁ∞°Â§©Ê∞£</title>
    <link rel="icon" type="image/png" href="./icon-v2.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --card-bg: rgba(255, 255, 255, 0.7);
            --glass-bg: rgba(255, 255, 255, 0.25);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(180deg, #FFF9E3 0%, #FFE8B8 100%);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
            transition: background 0.6s ease;
            padding-bottom: 40px;
        }

        body.dawn { background: linear-gradient(180deg, #E8E8E8 0%, #F5F5F7 100%); }
        body.day { background: linear-gradient(180deg, #FFF9E3 0%, #FFE8B8 100%); }
        body.evening { background: linear-gradient(180deg, #B8D8D8 0%, #8FB8C8 100%); }
        body.night { background: linear-gradient(180deg, #2C3E50 0%, #1A252F 100%); color: #FFFFFF; }

        .loading-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(180deg, #FFF9E3 0%, #FFE8B8 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top-color: #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .navbar {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 0.5px solid rgba(0, 0, 0, 0.05);
        }

        .nav-content {
            max-width: 600px;
            margin: 0 auto;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .location-selector {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Dropdown City Selector */
        .city-dropdown {
            padding: 6px 12px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.2);
            background: rgba(255,255,255,0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            cursor: pointer;
        }

        body.night .city-dropdown {
            background: rgba(255,255,255,0.15);
            color: white;
            border-color: rgba(255,255,255,0.3);
        }

        .update-time {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 24px 20px;
        }

        .hero-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 32px 24px;
            margin-bottom: 24px;
            border: 0.5px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.08);
        }

        .period-badge {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(0, 122, 255, 0.1);
            color: #007AFF;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .temp-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin: 20px 0;
        }

        .weather-icon {
            font-size: 80px;
            filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.1));
        }

        .temp-main {
            font-size: 72px;
            font-weight: 300;
            line-height: 1;
            letter-spacing: -2px;
        }

        .weather-desc {
            text-align: center;
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 24px;
            color: var(--text-secondary);
        }

        .advice-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding-top: 24px;
            border-top: 0.5px solid rgba(0, 0, 0, 0.1);
        }

        .advice-item {
            background: rgba(120, 120, 128, 0.08);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .advice-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .advice-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .advice-detail {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .section-header {
            font-size: 22px;
            font-weight: 600;
            margin: 32px 0 16px 4px;
        }

        .forecast-scroll {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 8px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .forecast-scroll::-webkit-scrollbar {
            display: none;
        }

        .forecast-card {
            min-width: 120px;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px 16px;
            text-align: center;
            border: 0.5px solid rgba(255, 255, 255, 0.5);
            flex-shrink: 0;
        }

        .forecast-time {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-secondary);
        }

        .forecast-icon {
            font-size: 40px;
            margin: 8px 0;
        }

        .forecast-temp {
            font-size: 20px;
            font-weight: 600;
            margin-top: 8px;
        }

        .forecast-rain {
            font-size: 12px;
            color: #007AFF;
            margin-top: 4px;
        }

        body.night .navbar,
        body.night .hero-card,
        body.night .forecast-card {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.1);
        }

        body.night .advice-item {
            background: rgba(255, 255, 255, 0.08);
        }

        body.night .update-time,
        body.night .weather-desc,
        body.night .advice-detail,
        body.night .forecast-time {
            color: rgba(255, 255, 255, 0.6);
        }

        body.night .period-badge {
            background: rgba(0, 122, 255, 0.2);
            color: #64B5F6;
        }

        .error-box {
            text-align: center;
            padding: 20px;
        }

        .retry-btn {
            margin-top: 16px;
            padding: 10px 24px;
            border-radius: 10px;
            border: none;
            background: #007AFF;
            color: white;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .retry-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>

<body>
    <div id="loading" class="loading-screen">
        <div class="spinner"></div>
        <p style="margin-top: 16px; font-weight: 500; color: var(--text-secondary);">ËºâÂÖ•Â§©Ê∞£Ë≥áÊñô...</p>
    </div>

    <nav class="navbar">
        <div class="nav-content">
            <div class="location-selector">
                <select id="citySelect" class="city-dropdown"></select>
            </div>
            <div class="update-time" id="updateTime">Êõ¥Êñ∞‰∏≠...</div>
        </div>
    </nav>

    <div class="container" id="mainContent" style="display: none;">
        <div id="heroCard"></div>
        <h2 class="section-header">È†êÂ†±</h2>
        <div class="forecast-scroll" id="futureForecasts"></div>
    </div>

    <script>
        console.log('=== Â§©Ê∞£ App ÈñãÂßãËºâÂÖ• ===');

        const CITIES = [
            'Ëá∫ÂåóÂ∏Ç', 'Êñ∞ÂåóÂ∏Ç', 'Ê°ÉÂúíÂ∏Ç', 'Ëá∫‰∏≠Â∏Ç', 'Ëá∫ÂçóÂ∏Ç', 'È´òÈõÑÂ∏Ç',
            'Âü∫ÈöÜÂ∏Ç', 'Êñ∞Á´πÂ∏Ç', 'Êñ∞Á´πÁ∏£', 'ËãóÊ†óÁ∏£', 'ÂΩ∞ÂåñÁ∏£', 'ÂçóÊäïÁ∏£',
            'Èõ≤ÊûóÁ∏£', 'ÂòâÁæ©Â∏Ç', 'ÂòâÁæ©Á∏£', 'Â±èÊù±Á∏£', 'ÂÆúËò≠Á∏£', 'Ëä±ËìÆÁ∏£',
            'Ëá∫Êù±Á∏£', 'ÊæéÊπñÁ∏£', 'ÈáëÈñÄÁ∏£', 'ÈÄ£Ê±üÁ∏£'
        ];
        
        const CITY_API_MAP = {
            'Ëá∫ÂåóÂ∏Ç': 'taipei',
            'Êñ∞ÂåóÂ∏Ç': 'newtaipei',
            'Ê°ÉÂúíÂ∏Ç': 'taoyuan',
            'Ëá∫‰∏≠Â∏Ç': 'taichung',
            'Ëá∫ÂçóÂ∏Ç': 'tainan',
            'È´òÈõÑÂ∏Ç': 'kaohsiung',
            'Âü∫ÈöÜÂ∏Ç': 'keelung',
            'Êñ∞Á´πÂ∏Ç': 'hsinchu-city',
            'Êñ∞Á´πÁ∏£': 'hsinchu',
            'ËãóÊ†óÁ∏£': 'miaoli',
            'ÂΩ∞ÂåñÁ∏£': 'changhua',
            'ÂçóÊäïÁ∏£': 'nantou',
            'Èõ≤ÊûóÁ∏£': 'yunlin',
            'ÂòâÁæ©Â∏Ç': 'chiayi-city',
            'ÂòâÁæ©Á∏£': 'chiayi',
            'Â±èÊù±Á∏£': 'pingtung',
            'ÂÆúËò≠Á∏£': 'yilan',
            'Ëä±ËìÆÁ∏£': 'hualien',
            'Ëá∫Êù±Á∏£': 'taitung',
            'ÊæéÊπñÁ∏£': 'penghu',
            'ÈáëÈñÄÁ∏£': 'kinmen',
            'ÈÄ£Ê±üÁ∏£': 'lienchiang'
        };

        let currentCityIndex = 1; // È†êË®≠Êñ∞ÂåóÂ∏Ç
        const API_BASE = "https://weather-newtaipei-lk.zeabur.app/api/weather";

        function getWeatherIcon(weather) {
            if (!weather) return "üå§Ô∏è";
            if (weather.includes("Êô¥")) return "‚òÄÔ∏è";
            if (weather.includes("Â§öÈõ≤")) return "‚õÖ";
            if (weather.includes("Èô∞")) return "‚òÅÔ∏è";
            if (weather.includes("Èõ®")) return "üåßÔ∏è";
            if (weather.includes("Èõ∑")) return "‚õàÔ∏è";
            return "üå§Ô∏è";
        }

        function getTimePeriod(startTime) {
            const hour = new Date(startTime).getHours();
            if (hour >= 5 && hour < 11) return "Ê∏ÖÊô®";
            if (hour >= 11 && hour < 14) return "‰∏≠Âçà";
            if (hour >= 14 && hour < 18) return "‰∏ãÂçà";
            if (hour >= 18 && hour < 23) return "Êôö‰∏ä";
            return "Ê∑±Â§ú";
        }

        function updateBackgroundByTime() {
            const hour = new Date().getHours();
            document.body.classList.remove('dawn', 'day', 'evening', 'night');
            if (hour >= 5 && hour < 11) document.body.classList.add('dawn');
            else if (hour >= 11 && hour < 18) document.body.classList.add('day');
            else if (hour >= 18 && hour < 23) document.body.classList.add('evening');
            else document.body.classList.add('night');
        }

        function parseTemp(tempStr) {
            if (!tempStr) return 0;
            const num = parseInt(tempStr.toString().replace(/[^0-9-]/g, ''));
            return isNaN(num) ? 0 : num;
        }

        function getAdvice(rainProb, maxTemp) {
            const rain = parseInt(rainProb) || 0;
            const temp = parseTemp(maxTemp);

            return {
                rain: rain > 30 
                    ? { icon: "‚òÇÔ∏è", text: "‰∫∫Âú®ÂÇòÂú®", detail: `ÈôçÈõ®Áéá ${rainProb}` } 
                    : { icon: "üåÇ", text: "‰∏çÁî®Â∏∂ÂÇò", detail: `ÈôçÈõ®Áéá ${rainProb}` },
                cloth: temp >= 28 
                    ? { icon: "üëï", text: "Áü≠Ë¢ñÂ∞±Â•Ω", detail: `ÊúÄÈ´ò ${maxTemp}` }
                    : temp <= 20 
                    ? { icon: "üß•", text: "Â∏∂‰∏äÂ§ñÂ•ó", detail: `ÊúÄÈ´ò ${maxTemp}` }
                    : { icon: "üëî", text: "ËàíÈÅ©Á©øÊê≠", detail: `ÊúÄÈ´ò ${maxTemp}` }
            };
        }

        function renderWeather(data) {
            const forecasts = data.forecasts;
            const current = forecasts[0];
            const others = forecasts.slice(1);

            const period = getTimePeriod(current.startTime);
            const avgTemp = Math.round((parseTemp(current.maxTemp) + parseTemp(current.minTemp)) / 2);
            const advice = getAdvice(current.rain, current.maxTemp);

            document.getElementById('heroCard').innerHTML = `
                <div class="hero-card">
                    <div class="period-badge">${period}</div>
                    <div class="temp-display">
                        <div class="weather-icon">${getWeatherIcon(current.weather)}</div>
                        <div class="temp-main">${avgTemp}¬∞</div>
                    </div>
                    <div class="weather-desc">${current.weather}</div>
                    <div class="advice-grid">
                        <div class="advice-item">
                            <div class="advice-icon">${advice.rain.icon}</div>
                            <div class="advice-title">${advice.rain.text}</div>
                            <div class="advice-detail">${advice.rain.detail}</div>
                        </div>
                        <div class="advice-item">
                            <div class="advice-icon">${advice.cloth.icon}</div>
                            <div class="advice-title">${advice.cloth.text}</div>
                            <div class="advice-detail">${advice.cloth.detail}</div>
                        </div>
                    </div>
                </div>
            `;

            const scrollContainer = document.getElementById('futureForecasts');
            scrollContainer.innerHTML = '';
            const todayDate = new Date().getDate();

            others.forEach(f => {
                let p = getTimePeriod(f.startTime);
                const fDate = new Date(f.startTime);
                if (fDate.getDate() !== todayDate) p = "ÊòéÂ§©" + p;

                scrollContainer.innerHTML += `
                    <div class="forecast-card">
                        <div class="forecast-time">${p}</div>
                        <div class="forecast-icon">${getWeatherIcon(f.weather)}</div>
                        <div class="forecast-temp">${f.minTemp} - ${f.maxTemp}</div>
                        <div class="forecast-rain">üíß ${f.rain}</div>
                    </div>
                `;
            });

            const now = new Date();
            const weekDays = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
            document.getElementById('updateTime').textContent =
                `${now.getMonth() + 1}/${now.getDate()} ÈÄ±${weekDays[now.getDay()]}`;
        }

        async function fetchWeather() {
            const cityName = CITIES[currentCityIndex];
            const cityCode = CITY_API_MAP[cityName];
            const API_URL = `${API_BASE}/${cityCode}`;

            try {
                const response = await fetch(API_URL);
                const json = await response.json();

                if (json.success && json.data) {
                    renderWeather(json.data);

                    setTimeout(() => {
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('mainContent').style.display = 'block';
                    }, 500);
                }
            } catch (error) {
                document.getElementById('loading').innerHTML = `
                    <div class="error-box">
                        <div style="font-size: 48px;">‚ö†Ô∏è</div>
                        <p style="margin-top: 16px; color: var(--text-secondary); font-weight: 500;">ÁÑ°Ê≥ïËºâÂÖ•Â§©Ê∞£Ë≥áÊñô</p>
                        <button class="retry-btn" onclick="location.reload()">ÈáçÊñ∞ËºâÂÖ•</button>
                    </div>
                `;
            }
        }

        /* ---------------------------
           ÂàùÂßãÂåñ Dropdown + ‰∫ã‰ª∂Á∂ÅÂÆö
           --------------------------- */
        document.addEventListener("DOMContentLoaded", () => {
            console.log('DOM ËºâÂÖ•ÂÆåÊàê');

            const citySelect = document.getElementById("citySelect");

            // Âª∫Á´ãÂüéÂ∏ÇÈÅ∏È†Ö
            CITIES.forEach((city, index) => {
                const option = document.createElement("option");
                option.value = index;
                option.textContent = city;
                citySelect.appendChild(option);
            });

            // Ë®≠ÂÆöÈ†êË®≠ÂÄºÔºàÊñ∞ÂåóÂ∏Ç index = 1Ôºâ
            citySelect.value = currentCityIndex;

            // Áï∂ÈÅ∏ÊìáËÆäÂãï ‚Üí Êõ¥Êñ∞ÂüéÂ∏Ç‰∏¶ËºâÂÖ•Â§©Ê∞£
            citySelect.addEventListener("change", () => {
                currentCityIndex = parseInt(citySelect.value);

                document.getElementById('loading').style.display = 'flex';
                document.getElementById('mainContent').style.display = 'none';

                fetchWeather();
            });

            updateBackgroundByTime();
            fetchWeather();
        });
    </script>
</body>

</html>
